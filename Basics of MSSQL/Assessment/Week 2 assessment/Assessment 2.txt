/* Top N Books per users */
select * from (select u.name, b.title, b.price, row_number() over (partition by u.user_id order by b.price desc) as Row_Num,
rank() over (partition by u.user_id order by b.price desc) as ranks,
DENSE_RANK() over (partition by u.user_id order by b.price desc) as d_rank
FROM ORDERS o
INNER JOIN users u ON o.user_id=u.user_id
INNER JOIN books b ON o.product_id=b.product_id) AS RankedBooks
WHERE Row_Num <= 2
ORDER BY  Row_Num;

/* Rank user by total spending */
select u.name, rank() over (order by sum(b.price) desc) as ranks,
dense_rank() over (order by sum(b.price) desc) as dense_ranks
FROM ORDERS o
INNER JOIN users u ON o.user_id=u.user_id
INNER JOIN books b ON o.product_id=b.product_id
group by u.name;